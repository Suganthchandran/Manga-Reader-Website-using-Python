{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="{% static 'CSS/style.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>

        .container{
            margin: 6% 9%;
        }

        body{
            background-color: black;
        }

        .back{
            margin-bottom: 3.5rem;
            margin-top: 11.5rem;
        }

        a{
            display: flex;
            flex-direction: row;
            color: white;
        }


        a h3{
            margin-left: 0.8rem;
            margin-top: -0.4rem;
            font-size: 2rem;
            font-weight: 700;
        }


        .banner{
            height: 300px !important;
            position: relative
        }
        
        .banner_image{
            width: 100%;
            height: 300px;
            object-fit: cover;
        }

        .overlay {
            position: absolute;     
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to top,black, rgba(0,0,0,0.88), rgba(0,0,0,0.5)); /* Vertical black fade effect */
        }

        .manga_content{
            position: absolute;
            top:50%;
            left:5%;
            width: 100%;
            display: grid;
            grid-template-columns: 300px auto;
        }

        .manga_content img{
            width: 100%;
            height: 300px;
            border-radius: 50%;
            border: 2px solid rgb(70, 70, 70);
            object-fit: cover;
        }

        .manga-right{
            display: flex;
            flex-direction: column;
        }

        .manga-right-content{
            margin-top: 5rem;
            margin-left: 5rem;
            margin-bottom: 5rem;
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--text-color);
        }

        .manga-right-content h2{
            font-size: 3rem;
            margin-top: 1.6rem;
        }

        .manga-right-content h5{
            margin-left: 0.4rem;
            margin-top: 1.2rem;
            margin-bottom: 1.5rem;
        }

        .manga-right-button
        {
            margin-left: 5rem;
            display: flex;
            flex-direction: row;
            align-items: center;
            gap:150px;
            position: absolute;
            top: 78%;
            left: 22.3%;
            cursor: pointer;
        } 

        .manga-right-button img{
            width: 35px; 
            height: 35px; 
            margin-right: 5px; 
            margin-bottom: 0.5rem;
            vertical-align: middle; 
            border: none;
        }

        .manga-right-button h5{
            color: white;
            font-size: 1.1rem;
            text-align: center;
            align-items: center;
            margin-left: -25%;
        }

        .manga-right-button h6{
            color: white;
            font-size: 1.1rem;
            text-align: center;
            align-items: center;
            margin-left: -27%;
            margin-top: 0.5rem;
        }

        #work-status{
            color: white;
            font-size: 1.5rem;
        }

        #work-status img, .back-image {
            width: 20px; 
            height: 20px; 
            margin-right: 5px; 
            vertical-align: middle; 
        }

        .upload-date{
            color: white;
        }

        .description-container {
            margin-top: 17rem;
            font-size: 1.3rem;
            color: rgb(200, 200, 200);
            padding: 2rem 12%;
            position: relative;
        }

        .description-short {
            overflow: hidden;
            max-height: 8rem; 
            transition: max-height 0.3s ease; 
        }

        .description-full {
            display: none; 
            max-height: none;
        }

        .expand-description {
            position: absolute;
            top: 60%;
            left: 47%;
            margin-top: 1rem;
            cursor: pointer;
        }

        .expand-description  {
            font-size: 24px;
            color: white;
        }

        .tot_chapters{
            color: white;
            font-size: 2.2rem;
            position: absolute;
            top:88%;
            left:10.3%;
        }

        hr{
            color: white;
        }


        .pdf-files{
            margin-top: 38rem;
            position: absolute;
            left: 10%;
            width: 78%;
        }

        .pdf-file{
            margin-bottom: 3rem;
            padding: 2rem 5rem;
            border: 1px solid white;
            background-color: rgb(48, 48, 48);
            transition: 0.5s ease;
        }

        .pdf-file:hover{
            transform: translateY(-7%);
        }
        
        .sort-dropdown{
            position : absolute;
            top: 0%;
            left: 670%;
            display: inline-block;
        }
        
        #sort-chapters{
            background-color: #4b0d5e;
            color: white;
            padding: 10px;
            font-size: 16px;
            border: none;
            border-radius: 50px;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            cursor: pointer;
            outline: none;
        }

        #sort-chapters img{
            width: 100px;
        }

        .sort-dropdown option{
            background-color: #4b0d5e;
            color: white;
            padding: 10px;
        }

        .download-btn {
    background-color: #4CAF50; /* Green background */
    color: white; /* White text */
    padding: 10px 20px; /* Padding around text */
    text-align: center; /* Centered text */
    text-decoration: none; /* Remove underlining */
    border-radius: 5px; /* Rounded corners */
    border: none;
    cursor: pointer; /* Pointer cursor on hover */
    display: inline-block;
    margin-top: 10px;
    font-size: 1rem;
}

.download-btn:hover {
    background-color: #45a049; /* Darker green on hover */
}

.pdf-file {
    margin-bottom: 3rem;
    padding: 2rem 5rem;
    border: 1px solid white;
    background-color: rgb(48, 48, 48);
    transition: 0.5s ease;
}

.pdf-file.read {
    opacity: 0.5; /* Low opacity for read chapters */
    background-color: rgb(70, 70, 70); /* Optional: change the background to indicate it's read */
}

.mark-read-btn {
    background-color: #4CAF50;
    color: white;
    padding: 8px 15px;
    font-size: 14px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    display: inline-block;
    margin-top: 10px;
}

.mark-read-btn:hover {
    background-color: #45a049;
}

.pdf-file {
    margin: 20px;
    padding: 10px;
    border: 1px solid #ddd;
    transition: opacity 0.3s ease;
}

.read {
    opacity: 0.5;  /* Reduces opacity to mark the chapter as read */
}

button {
    margin: 5px;
}

.search-bar-container {
    text-align: right; /* Aligns the search bar to the right */
    margin-bottom: 10px; /* Adds a bit of space between search and chapter list */
}

#chapter-search {
    padding: 5px 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
    font-size: 14px;
    width: 200px; /* You can adjust this as needed */
}

.resume-button {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background-color: #4CAF50;
    color: white;
    padding: 15px 25px;
    font-size: 16px;
    border: none;
    border-radius: 50px;
    cursor: pointer;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    transition: background-color 0.3s ease;
}

.resume-button:hover {
    background-color: #45a049;
}




    </style>
</head>
<body>
    {% include 'manga/inc/Navbar.html' %}
    <div class="container">
        <input type="hidden" value="{{ comics.id }}" id="bid">
        {% csrf_token %}
        <div class="back">
            <a href="{% url 'genreview' comics.genre.name %}">
                <img src="{% static 'Images/Back.png' %}" class="back-image" alt="Back">
                <h3>Back</h3>
            </a>                      
        </div>
        <div class="banner">
            <img src="{{ comics.banner_image.url }}" class="banner_image" alt="Banner_Image" />
            <div class="overlay"></div>
            <div class="manga_content">
                <div class="manga-left">
                    <img src="{{ comics.manga_image.url }}" alt="{{comics.name}}">
                </div>
                <div class="manga-right">
                    <div class="manga-right-content">
                        <h2>{{comics.name}}</h2>
                        <h5><pre>Japanese Name  :  {{comics.japanese_name}}</pre></h5>
                        <h5><pre>Author  :  {{comics.author}}</pre></h5>
                        <h3 id="work-status"></h3>
                    </div>
                    <div class="manga-right-button">
                        <div class="heart">
                            <img src="{% static 'Images/like.png' %}" id="library" alt="Heart">
                            <h5>In library</h5>
                        </div>
                        <div class="web">
                            <img src="{% static 'Images/earth2.png' %}" id="search-google" alt="World Icon" style="width: 30px; height: 30px; cursor: pointer;">
                            <h6>Web View</h6>
                        </div>
                    </div>
                </div>
            </div>
            <div class="description-container">
                <div class="description-short">
                    {{ comics.description|truncatewords_html:50 }}
                </div>
                <div class="description-full" style="display: none;"> 
                    {{ comics.description }} 
                </div>
                <div class="expand-description">
                    <img src="{% static 'Images/arrow-down.png' %}" id="expand-icon" width="20px" height="20px" alt="Arrow">
                </div>
            </div>
        </div>
        <div class="tot_chapters">
        <h4><pre>{{comics.tot_chapters}}  chapters</pre></h4>
        
        <div class="sort-dropdown">
            <select id="sort-chapters">
                <option value="sort">--SORT-BY--</option>
                <option value="asc">Chapters <span>&#8595;</span><!--<img src="{% static 'Images/up.png' %}" >--></option>
                <option value="desc">Chapters <span>&#8593;</span><!--<img src="{% static 'Images/down.png' %}" >--></option>
            </select>

            
        </div>

        <div class="search-bar-container">
            <input type="text" id="chapter-search" placeholder="Search Chapter..." />
        </div>
        
        </div>
        <hr>
        
        <button id="resume-button" class="resume-button">Resume</button>

        <div class="download-dropdown">
            <select id="download-chapters">
                <option value="">Download</option>
                <option value="next-5">Next 5 Unread Chapters</option>
                <option value="next-10">Next 10 Unread Chapters</option>
                <option value="all-unread">All Unread Chapters</option>
                <option value="all">All Chapters</option>
                <option value="custom-range">Custom Range</option>
            </select>
        </div>

        
        <div class="pdf-files">
           

            
            {% for pdf in pdf_files %}
            <div class="pdf-file" id="chapter-{{ pdf.chapter_number }}">
                
                <!-- Mark as Read Button -->
                <button class="mark-read-btn" data-chapter-id="{{ pdf.chapter_number }}">Mark as Read</button>
                
                <!-- Chapter Link - Clicking this will open the chapter and mark it as read -->
                <a href="{% url 'chapter' comics.id pdf.chapter_number %}" class="chapter-link" data-chapter-id="{{ pdf.chapter_number }}">
                    <h1 class="pdf_chapters">Vol 1 - Chapter {{ pdf.chapter_number }}</h1>
                </a>
                
                <!-- Download Button - Separate from the chapter link -->
                <a href="{{ pdf.file.url }}" download>
                    <button class="download-btn">Download Chapter {{ pdf.chapter_number }}</button>
                </a>
                
            </div>
            {% endfor %}
        </div>
        
        
    </div>


    <script>
        
        var workStatus = "{{ comics.work_status }}"; 
        if (workStatus === 'True') {
            document.getElementById('work-status').innerHTML = '<img src="{% static "Images/double-tick.png" %}" style="border:none;" alt="Completed"> Completed';
        } else {
            document.getElementById('work-status').innerHTML = '<img src="{% static "Images/time-left.png" %}" style="border:none;" alt="Ongoing"> Ongoing';
        }

        // Library 

        const bid = document.getElementById('bid').value;
        const tkn = document.querySelector('[name="csrfmiddlewaretoken"]').value;
        const library = document.getElementById('library');

        library.addEventListener("click", function () {
            let obj = {
                bid: bid,
                token: tkn
            };
            console.log(obj);
            fetch("{% url 'add_to_library' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": tkn,
                    "X-Requested-With": "XMLHttpRequest"
                },
                body: JSON.stringify(obj)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'Login to Add to Library') {
                    alert('Please log in to add manga to your library.');
                    window.location.href = "{% url 'login' %}";
                } else if (data.status === 'Manga Already in Library') {
                    alert('This manga is already in your library.');
                } else if (data.status === 'Manga Added to Library') {
                    alert('Manga added to your library successfully!');
                } else {
                    alert('An error occurred: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        });

        const pdfChapters = document.querySelectorAll('.pdf_chapters');
        pdfChapters.forEach((element, index) => {
            element.innerHTML = "Vol 1 - Chapter " + (index + 1);
        });

        document.querySelector('.expand-description').addEventListener('click', function() {
    var descriptionShort = document.querySelector('.description-short');
    var descriptionFull = document.querySelector('.description-full');
    var expandIcon = document.getElementById('expand-icon');

    if (descriptionShort.style.maxHeight === '2.5em') {
        descriptionShort.style.maxHeight = 'none';
        descriptionShort.style.display = 'none';
        descriptionFull.style.display = 'block';
        expandIcon.src = '{% static "Images/up-arrow.png" %}';
    } else {
        descriptionShort.style.maxHeight = '2.5em';
        descriptionFull.style.display = 'none';
        descriptionShort.style.display = 'block';
        expandIcon.src = '{% static "Images/arrow-down.png" %}';
    }
});

document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('sort-chapters').addEventListener('change', function() {
        const selectedOption = this.value;
        const chapterContainer = document.querySelector('.pdf-files');
        const chapters = chapterContainer.querySelectorAll('.pdf-file');
    
        if (selectedOption === 'asc') {
            const sortedChapters = Array.from(chapters).sort((a, b) => {
                const pdfChaptersA = a.querySelector('.pdf_chapters').textContent.trim().split(' ');
                const pdfChaptersB = b.querySelector('.pdf_chapters').textContent.trim().split(' ');
                const chapterA = parseInt(pdfChaptersA[pdfChaptersA.length - 1]); 
                const chapterB = parseInt(pdfChaptersB[pdfChaptersB.length - 1]); 
                return chapterA - chapterB;
            });
            chapterContainer.innerHTML = ''; 
            sortedChapters.forEach(chapter => { 
                chapterContainer.appendChild(chapter);
            });
        } else if (selectedOption === 'desc') {
            const sortedChapters = Array.from(chapters).sort((a, b) => {
                const pdfChaptersA = a.querySelector('.pdf_chapters').textContent.trim().split(' ');
                const pdfChaptersB = b.querySelector('.pdf_chapters').textContent.trim().split(' ');
                const chapterA = parseInt(pdfChaptersA[pdfChaptersA.length - 1]); 
                const chapterB = parseInt(pdfChaptersB[pdfChaptersB.length - 1]); 
                return chapterB - chapterA;
            });
            chapterContainer.innerHTML = ''; 
            sortedChapters.forEach(chapter => {
                chapterContainer.appendChild(chapter);
            });
        }
    });
});


document.getElementById('search-google').addEventListener('click', function() {
            const mangaName = "{{ comics.name }}";
            const googleSearchUrl = `https://www.google.com/search?q=${encodeURIComponent(mangaName)}`;
            window.open(googleSearchUrl, '_blank');
        });
      

        document.addEventListener('DOMContentLoaded', function() {
    // Get the manga ID to uniquely identify the chapters
    const mangaId = "{{ comics.id }}"; // Check this is working properly
    console.log("Manga ID:", mangaId);

    // Select all the chapter elements
    const chapterLinks = document.querySelectorAll('.chapter-link'); // Assuming '.chapter-link' is the class for chapter links
    const buttons = document.querySelectorAll('.mark-read-btn');
    console.log("Found chapter links:", chapterLinks.length);
    console.log("Found mark-read buttons:", buttons.length);

    // Loop through each chapter link and add a click event listener
    chapterLinks.forEach(link => {
        link.addEventListener('click', function(event) {
            const chapterId = this.getAttribute('data-chapter-id');
            console.log("Chapter clicked:", chapterId);
            markChapterAsRead(chapterId);
        });
    });

    // Loop through each mark-read button to add a click event listener
    buttons.forEach(button => {
        button.addEventListener('click', function() {
            const chapterId = this.getAttribute('data-chapter-id');
            console.log("Mark-read button clicked for:", chapterId);
            toggleChapterReadState(chapterId);
        });
    });

    // Function to mark a chapter as read
    function markChapterAsRead(chapterId) {
        const chapterElement = document.getElementById('chapter-' + chapterId);
        const button = chapterElement ? chapterElement.querySelector('.mark-read-btn') : null;
        if (chapterElement && button && !chapterElement.classList.contains('read')) {
            console.log("Marking as read:", chapterId);
            chapterElement.classList.add('read');
            chapterElement.style.opacity = '0.5';
            button.textContent = 'Mark as Unread';
            persistReadState();
        } else {
            console.log("Could not mark as read:", chapterId);
        }
    }

    // Function to toggle read/unread state when clicking the mark-read button
    function toggleChapterReadState(chapterId) {
        const chapterElement = document.getElementById('chapter-' + chapterId);
        const button = chapterElement ? chapterElement.querySelector('.mark-read-btn') : null;
        if (chapterElement && button) {
            if (chapterElement.classList.contains('read')) {
                console.log("Unmarking as read:", chapterId);
                chapterElement.classList.remove('read');
                chapterElement.style.opacity = '1';
                button.textContent = 'Mark as Read';
            } else {
                console.log("Marking as read through button:", chapterId);
                chapterElement.classList.add('read');
                chapterElement.style.opacity = '0.5';
                button.textContent = 'Mark as Unread';
            }
            persistReadState();
        } else {
            console.log("Could not toggle read state for:", chapterId);
        }
    }

    // Function to persist the read/unread state
    function persistReadState() {
        const readChapters = [];
        document.querySelectorAll('.pdf-file.read').forEach(chapter => {
            const chapterId = chapter.id.replace('chapter-', '');
            readChapters.push(chapterId);
        });
        // Store read chapters in localStorage with manga-specific key
        console.log("Saving read chapters:", readChapters);
        localStorage.setItem(`readChapters_${mangaId}`, JSON.stringify(readChapters));
    }

    // On page load, check localStorage and set the initial state for the chapters
    const readChapters = JSON.parse(localStorage.getItem(`readChapters_${mangaId}`)) || [];
    console.log("Loaded read chapters from storage:", readChapters);
    readChapters.forEach(chapterId => {
        const chapterElement = document.getElementById('chapter-' + chapterId);
        const button = chapterElement ? chapterElement.querySelector('.mark-read-btn') : null;
        if (chapterElement && button) {
            console.log("Setting chapter as read on page load:", chapterId);
            chapterElement.classList.add('read');
            chapterElement.style.opacity = '0.5';
            button.textContent = 'Mark as Unread';
        } else {
            console.log("Could not set read state for:", chapterId);
        }
    });
});




document.addEventListener('DOMContentLoaded', function() {
    // Handle the download dropdown
    document.getElementById('download-chapters').addEventListener('change', function() {
        const selectedOption = this.value;
        const chapters = document.querySelectorAll('.pdf-file');
        
        let chaptersToDownload = [];

        // Handle each case for downloading
        switch (selectedOption) {
            case 'next-5':
                chaptersToDownload = getNextUnreadChapters(chapters, 5);
                break;
            case 'next-10':
                chaptersToDownload = getNextUnreadChapters(chapters, 10);
                break;
            case 'all-unread':
                chaptersToDownload = getAllUnreadChapters(chapters);
                break;
            case 'all':
                chaptersToDownload = chapters;
                break;
            case 'custom-range':
                // Handle custom range input
                let start = prompt('Enter start chapter number:');
                let end = prompt('Enter end chapter number:');
                chaptersToDownload = getChaptersInRange(chapters, start, end);
                break;
        }

        // Download the selected chapters
        downloadChapters(chaptersToDownload);
    });

    // Function to get unread chapters
    function getUnreadChapters(chapters) {
        return Array.from(chapters).filter(chapter => !chapter.classList.contains('read'));
    }

    // Function to get the next 'n' unread chapters in ascending order
    function getNextUnreadChapters(chapters, n) {
        const unreadChapters = getUnreadChapters(chapters);
        const sortedChapters = unreadChapters.sort((a, b) => {
            const chapterA = parseInt(a.querySelector('.pdf_chapters').textContent.split(' ')[2]);
            const chapterB = parseInt(b.querySelector('.pdf_chapters').textContent.split(' ')[2]);
            return chapterA - chapterB;
        });
        return sortedChapters.slice(0, n);
    }

    // Function to get all unread chapters
    function getAllUnreadChapters(chapters) {
        return getUnreadChapters(chapters);
    }

    // Function to get chapters in a specific range
    function getChaptersInRange(chapters, start, end) {
        const rangeChapters = Array.from(chapters).filter(chapter => {
            const chapterNumber = parseInt(chapter.querySelector('.pdf_chapters').textContent.split(' ')[2]);
            return chapterNumber >= start && chapterNumber <= end;
        });
        return rangeChapters;
    }

    // Function to download chapters
    function downloadChapters(chaptersToDownload) {
        if (chaptersToDownload.length === 0) {
            alert('No chapters to download.');
            return;
        }

        chaptersToDownload.forEach(chapter => {
            const downloadButton = chapter.querySelector('.download-btn');
            if (downloadButton) {
                const downloadUrl = downloadButton.getAttribute('href');
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = `Chapter-${chapter.querySelector('.pdf_chapters').textContent.trim()}.pdf`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                // chapter.classList.add('read');
                // chapter.style.opacity = '0.5'; // Make it appear as read
                // const markReadButton = chapter.querySelector('.mark-read-btn');
                // if (markReadButton) {
                //     markReadButton.textContent = 'Mark as Unread';
                // }


            }
        });
    }
});

const searchInput = document.getElementById("chapter-search");

searchInput.addEventListener("input", function() {
    const searchTerm = this.value.toLowerCase();
    const chapters = document.querySelectorAll(".pdf-file");

    chapters.forEach(chapter => {
        const chapterNumber = chapter.id.split("-")[1]; // Gets the chapter number
        if (chapterNumber.includes(searchTerm)) {
            chapter.style.display = "block"; // Show matching chapters
        } else {
            chapter.style.display = "none"; // Hide non-matching chapters
        }
    });
});

searchInput.addEventListener("keypress", function(event) {
    if (event.key === "Enter") {
        event.preventDefault(); // Prevents the default form submission if any
        searchInput.value = ""; // Clears the input field
    }
});

document.getElementById("resume-button").addEventListener("click", function() {
    // Get all chapter elements
    const chapters = document.querySelectorAll(".pdf-file");
    let foundUnread = false;

    // Loop through chapters to find the first unread one
    for (let chapter of chapters) {
        // Check if the chapter is unread by checking for the "read" class absence
        if (!chapter.classList.contains("read")) {
            // Scroll to the first unread chapter
            chapter.scrollIntoView({ behavior: "smooth", block: "center" });
            
            // Optionally, you could open the chapter link if needed
            const chapterLink = chapter.querySelector("a");
            if (chapterLink) {
                window.location.href = chapterLink.href;
            }
            
            foundUnread = true;
            break;
        }
    }

    if (!foundUnread) {
        alert("All chapters are marked as read.");
    }
});


    </script>
</body>
</html>
